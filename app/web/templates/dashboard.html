{% extends "base.html" %}
{% block title %}{{ t("dashboard.title", lang) }} Â· {{ app_name }}{% endblock %}

{% block content %}
<h1 class="h1">{{ t("dashboard.title", lang) }}</h1>

<div class="grid">
    <!-- Left column -->
    <div class="stack">
        <div class="card">
            <div class="card__title">{{ t("dashboard.status", lang) }}</div>

            <div class="kv">
                <div class="kv__row">
                    <div class="kv__k">{{ t("dashboard.connected", lang) }}</div>
                    <div class="kv__v">
                        <span id="status-connected" class="badge {% if connected %}badge--ok{% else %}badge--bad{% endif %}">
                            {% if connected %}{{ t("common.yes", lang) }}{% else %}{{ t("common.no", lang) }}{% endif %}
                        </span>
                    </div>
                </div>

                <div class="kv__row">
                    <div class="kv__k">{{ t("dashboard.bot_enabled", lang) }}</div>
                    <div class="kv__v">
                        <span id="status-enabled" class="badge {% if bot_enabled %}badge--ok{% else %}badge--warn{% endif %}">
                            {% if bot_enabled %}{{ t("common.yes", lang) }}{% else %}{{ t("common.no", lang) }}{% endif %}
                        </span>
                    </div>
                </div>

                <div class="kv__row">
                    <div class="kv__k">{{ t("dashboard.target", lang) }}</div>
                    <div class="kv__v">{{ target_channel }}</div>
                </div>

                <div class="kv__row">
                    <div class="kv__k">{{ t("dashboard.session", lang) }}</div>
                    <div class="kv__v">{{ session_name }}</div>
                </div>

                <div class="kv__row">
                    <div class="kv__k">{{ t("dashboard.server_time", lang) }}</div>
                    <div class="kv__v">{{ server_time_utc }}</div>
                </div>
            </div>

            <div class="space"></div>

            <div class="card__title">{{ t("dashboard.controls", lang) }}</div>
            <div class="controls">
                <form method="post" action="/controls/enable">
                    <button class="btn btn--primary" type="submit">{{ t("dashboard.enable", lang) }}</button>
                </form>
                <form method="post" action="/controls/disable">
                    <button class="btn" type="submit">{{ t("dashboard.disable", lang) }}</button>
                </form>
                <form method="post" action="/controls/restart">
                    <button class="btn" type="submit">{{ t("dashboard.restart", lang) }}</button>
                </form>
                <form method="post" action="/controls/cleanup">
                    <button class="btn" type="submit">{{ t("dashboard.cleanup", lang) }}</button>
                </form>
            </div>
            <div class="muted small">{{ t("dashboard.restart_hint", lang) }}</div>
        </div>

        <!-- Compact channel change block (left bottom) -->
        <div class="card card--compact">
            <div class="card__title">{{ t("dashboard.target_manage", lang) }}</div>

            {% if error %}
            <div class="alert alert--bad">{{ error }}</div>
            {% endif %}

            <form method="post" action="/controls/target-channel" class="form form--inline">
                <input class="input" name="target_channel" value="{{ target_channel }}" />
                <input type="hidden" name="lang" value="{{ lang }}" />
                <button class="btn btn--primary" type="submit">{{ t("dashboard.target_save", lang) }}</button>
            </form>
            <div class="muted small">{{ t("dashboard.target_hint", lang) }}</div>
        </div>
    </div>

    <!-- Right column -->
    <div class="stack">
        <div class="card card--compact">
            <div class="card__title">{{ t("dashboard.last_error", lang) }}</div>
            <div id="last-error" class="{% if last_error %}mono pre{% else %}muted{% endif %}">
                {% if last_error %}
                {{ last_error }}
                {% else %}
                {{ t("dashboard.no_errors", lang) }}
                {% endif %}
            </div>
        </div>

        <div class="card card--compact">
            <div class="card__title">{{ t("dashboard.last_event", lang) }}</div>
            <div id="last-event-time" class="muted small">
                {% if last_event_time %}{{ last_event_time }}{% else %}{% endif %}
            </div>
            <div id="last-event-message" class="{% if last_event_message %}mono pre{% else %}muted{% endif %}">
                {% if last_event_message %}
                {{ last_event_message }}
                {% else %}
                {{ t("dashboard.no_events", lang) }}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    (() => {
      const yesText = "{{ t('common.yes', lang) }}";
      const noText = "{{ t('common.no', lang) }}";
      const noErrorsText = "{{ t('dashboard.no_errors', lang) }}";
      const noEventsText = "{{ t('dashboard.no_events', lang) }}";

      const connectedEl = document.getElementById("status-connected");
      const enabledEl = document.getElementById("status-enabled");
      const lastErrorEl = document.getElementById("last-error");
      const lastEventTimeEl = document.getElementById("last-event-time");
      const lastEventMessageEl = document.getElementById("last-event-message");

      const applyBadge = (el, ok, okClass, badClass) => {
        el.classList.remove("badge--ok", "badge--bad", "badge--warn");
        el.classList.add(ok ? okClass : badClass);
        el.textContent = ok ? yesText : noText;
      };

      const updateStatus = async () => {
        try {
          const resp = await fetch("/api/status", { headers: { "Accept": "application/json" } });
          if (!resp.ok) return;
          const data = await resp.json();

          applyBadge(connectedEl, !!data.connected, "badge--ok", "badge--bad");
          applyBadge(enabledEl, !!data.bot_enabled, "badge--ok", "badge--warn");

          if (data.last_error) {
            lastErrorEl.className = "mono pre";
            lastErrorEl.textContent = data.last_error;
          } else {
            lastErrorEl.className = "muted";
            lastErrorEl.textContent = noErrorsText;
          }

          if (data.last_event_time) {
            lastEventTimeEl.textContent = data.last_event_time;
          } else {
            lastEventTimeEl.textContent = "";
          }

          if (data.last_event_message) {
            lastEventMessageEl.className = "mono pre";
            lastEventMessageEl.textContent = data.last_event_message;
          } else {
            lastEventMessageEl.className = "muted";
            lastEventMessageEl.textContent = noEventsText;
          }
        } catch (_) {
          // ignore
        }
      };

      updateStatus();
      setInterval(updateStatus, 5000);
    })();
</script>
{% endblock %}
